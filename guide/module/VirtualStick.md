# 虚拟摇杆指南

虚拟摇杆功能模拟了遥控器的操作杆工作，可以通过软件的形式发送摇杆命令信号来模拟手动飞行实现自动飞行。在虚拟摇杆组件中，用户可以自行开启或者关闭虚拟摇杆的功能。或者发送摇杆的指令到飞行器上。

> 注意：使用虚拟摇杆的功能，需要飞行器不处于任何自动模式中，并且物理遥控器处于“非接管”模式或关机状态。
>

### 虚拟摇杆相关教程

---

虚拟摇杆是一种在屏幕上模拟真实摇杆的控制器，可以用来操纵无人机或其他游戏对象的移动和旋转。虚拟摇杆通常由两个部分组成：

- 一个固定的背景圆盘
- 一个可移动的前景圆盘

用户可以通过触摸或点击屏幕上的前景圆盘，来改变它相对于背景圆盘的位置和角度，从而产生不同的摇杆命令。

虚拟摇杆的工作原理是根据前景圆盘相对于背景圆盘中心点的偏移量（x,y）来计算出两个参数：方向和力度。

- 方向是指偏移量与水平轴之间形成的夹角（θ），可以用反正切函数 atan2(y,x) 来求得。
- 力度是指偏移量与背景圆盘半径（r）之间形成的比例（d），可以用勾股定理 sqrt(x**2+y**2) 来求得，并且限制在 0 到 1 之间。

这两个参数可以用来控制无人机在空间中沿着方向移动一定距离或旋转一定角度。

### 控制权说明

---

在目前系统中存在多路控制权的问题。

- 机巢系统发出的虚拟摇杆指令——manual control for mavlink
- 物理遥控器发出的摇杆指令——sbus protocol指令

在同一个时刻，仅存在如下几种情况：

1. 只有物理遥控器与无人机连接——sbus直接控制飞行器
2. 只有机巢系统的虚拟摇杆模式与无人机连接——manual control直接控制飞行器
3. 物理遥控器开机的情况下，机巢系统被用户触发了虚拟摇杆——**机巢系统优先级大于物理遥控器**
4. 物理遥控器触发特殊通道，飞控将不接收机巢系统的虚拟摇杆指令——sbus控制飞行器

### 接口调用流程

---

目前虚拟摇杆相关的接口仅暴露如下

1. `setJoyStickEnable`
2. `sendJoyStickControl`

   ![虚拟摇杆控制流程](https://imgs.wiki/imgs/2023/03/01/ce9489ea642a89a8.jpg)


详细的使用方法请查看SDK API 文档中FlyControllerManager虚拟摇杆相关接口。